<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 페이지</title>
</head>
<body>
  <h1>관리자 페이지</h1>
  <p>글 / 댓글 / 사용자 목록을 확인하고 삭제할 수 있습니다.</p>

  <h2>전체 글</h2>
  <ul id="posts"></ul>

  <h2>전체 댓글</h2>
  <ul id="comments"></ul>

  <h2>전체 사용자</h2>
  <ul id="users"></ul>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert("로그인이 필요합니다.");
      location.href = '/auth/login.html';
    }

    fetch('/auth/me', {
      headers: { Authorization: `Bearer ${token}` }
    })
      .then(res => res.json())
      .then(user => {
        if (!user.is_admin) {
          alert("관리자 전용 페이지입니다.");
          location.href = '/';
        } else {
          loadAllData();
        }
      })
      .catch(err => alert("auth/me 오류: " + err));

    function loadAllData() {
      fetch('/admin/posts', {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => {
          alert("[posts] 상태코드: " + res.status);
          return res.json();
        })
        .then(posts => {
          alert("[posts] 데이터 수: " + posts.length);
          const ul = document.getElementById('posts');
          posts.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `[${p.category}] <strong>${p.title}</strong> (id: ${p.id})
              <button onclick="deletePost(${p.id})">삭제</button>`;
            ul.appendChild(li);
          });
        })
        .catch(err => alert("[posts] 오류: " + err));

      fetch('/admin/comments', {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => {
          alert("[comments] 상태코드: " + res.status);
          return res.json();
        })
        .then(comments => {
          alert("[comments] 데이터 수: " + comments.length);
          const ul = document.getElementById('comments');
          comments.forEach(c => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${c.username}</strong> on <em>${c.post_title}</em>: ${c.content}
              <button onclick="deleteComment(${c.id})">삭제</button>`;
            ul.appendChild(li);
          });
        })
        .catch(err => alert("[comments] 오류: " + err));

      fetch('/admin/users', {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => {
          alert("[users] 상태코드: " + res.status);
          return res.json();
        })
        .then(users => {
          alert("[users] 데이터 수: " + users.length);
          const ul = document.getElementById('users');
          users.forEach(u => {
            const li = document.createElement('li');
            li.textContent = `${u.username} (ID: ${u.id}) ${u.is_admin ? '[관리자]' : ''}`;
            ul.appendChild(li);
          });
        })
        .catch(err => alert("[users] 오류: " + err));
    }

    function deletePost(id) {
      if (!confirm('이 글을 삭제하시겠습니까?')) return;
      fetch(`/admin/posts/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      }).then(() => location.reload());
    }

    function deleteComment(id) {
      if (!confirm('이 댓글을 삭제하시겠습니까?')) return;
      fetch(`/admin/comments/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      }).then(() => location.reload());
    }
  </script>
</body>
</html>
